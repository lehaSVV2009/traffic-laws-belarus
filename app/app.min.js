var APP={models:{},stores:{},views:{},controllers:{},util:{},context:{},user:null,test:null,init:function(){var t=this;t._initContexts(),t._loadStores()},_initContexts:function(){var t=this;t._initContext(t.stores),t._initContext(t.views),t._initContext(t.controllers)},_initContext:function(t){var e,n=this.context;$.each(t,function(s){e=new t[s],n[s]=e})},_loadStores:function(){var t=this,e=t.stores,n=t.context;$.each(e,function(t){n[t].load()})},obj:function(t){return this.context[t]}};!function(t){t.models.Model=Class.extend({type:"app.models.Model",idProperty:"id",data:{},init:function(t){this.data=t},get:function(t){return this.data[t]},set:function(t,e){this.data[t]=e}})}(APP),function(t){t.models.Chapter=t.models.Model.extend({type:"app.models.Chapter",fields:["id","title","text"],init:function(t){this._super(t)}})}(APP),function(t){t.models.Question=t.models.Model.extend({type:"app.models.Question",fields:["id","chapterId","title","variants","correct"],init:function(t){this._super(t)}})}(APP),function(t){t.models.Test=t.models.Model.extend({type:"app.models.Test",fields:["questions","answers","questionId","specific"],init:function(t){this._super(t)},getCurrentQuestion:function(){var t=this;return t.get("questions")[t.get("questionId")]},isLast:function(t){var e=this;return e.get("questions").length-1===t}})}(APP),function(t){t.models.User=t.models.Model.extend({type:"app.models.User",fields:["username","level","finishedChapters","nextChapter","wrongAnswers"],init:function(t){this.idProperty="username",this._super(t)}})}(APP),function(t){t.stores.Store=Class.extend({model:null,init:function(t){this.records=t&&0!==t.length?t:[]},addRecord:function(t){this.records.push(t)},load:function(t,e){var n,s=this,i=s.model;(t||i)&&$.getJSON(t,function(t){$.each(t,function(t,e){n=new i(e),s.addRecord(n)}),e&&e.apply(s,t)})},getRecords:function(){return this.records},findById:function(t){var e,n=this,s=n.getRecords();if(0===s.length)return null;for(var i=0;i<s.length;++i)if(e=s[i],e.get(e.idProperty)===t)return e;return null},create:function(t){var e=this,n=new e.model(t);return e.addRecord(n),n},count:function(){return this.records.length}})}(APP),function(t){t.stores.Chapters=t.stores.Store.extend({type:"app.stores.Chapters",init:function(){this.model=t.models.Chapter,this._super()},load:function(){this._super("json/chapters.json")},getTitle:function(t){var e=this,n=e.findById(t);return n?n.get("title"):null},getTitles:function(t){var e,n=this,s=[];return $.each(t,function(t,i){e=n.getTitle(i),e&&s.push(e)}),s}})}(APP),function(t){t.stores.Questions=t.stores.Store.extend({init:function(){this.model=t.models.Question,this._super()},load:function(){this._super("json/questions.json")},filterByChapter:function(t){var e=this,n=e.getRecords(),s=[];return $.each(n,function(e,n){n.get("chapterId")===t&&s.push(n)}),s},getRandomQuestions:function(t,e,n){var s=this;return s.getRandomQuestionsFrom(s.filterByChapter(t),t,e,n)},getRandomQuestionsFrom:function(t,e,n,s){if(0===t.length||0===n)return[];for(var i,o=this,r=[],a=0;n>a;++a)i=o.getRandomQuestion(t.length,t,s),i&&(r.push(i),s.push(i.get("id")));return r},getRandomTest:function(e,n){var s=this;return new t.models.Test({questionId:0,questions:s.getRandomQuestions(e,n,[]),answers:s.getDefaultAnswers(n),specific:!1})},getDefaultAnswers:function(t){for(var e={},n=0;t>n;++n)e[n]=2;return e},getRandomQuestion:function(t,e,n){t>e.length&&(t=e.length);for(var s=this,i=e[s.randomInt(t)],o=15;-1!==n.indexOf(i.get("id"))&&0!==o;)i=e[s.randomInt(t)],--o;return 0===o?null:i},randomInt:function(t){return Math.floor(Math.random()*t)}})}(APP),function(t){t.stores.Users=t.stores.Store.extend({init:function(){this.model=t.models.User,this._super()}})}(APP),function(t){t.stores.WrongAnswers=t.stores.Questions.extend({init:function(){this.model=t.models.Question,this._super()},load:function(){}})}(APP),function(t){t.views.View=Class.extend({type:"app.views.View",init:function(){},render:function(t,e){}})}(APP),function(t){t.views.Docs=t.views.View.extend({type:"app.views.Docs",init:function(){this._super()},render:function(e,n){var s=n.title,i=n.text;e.html('<div class="container-fluid bg-info">   <div class="modal-dialog">       <div class="modal-content">           <div class="modal-header">'+s+'               <div class="modal-body">'+i+'               </div>               <div class="modal-footer">                   <button id="startTest" class="btn btn-large btn-primary" type="button">                       Начать тест                   </button>               </div>           </div>       </div>   </div></div>'),$("#startTest").on("click",function(){t.obj("Controller").onStartSimpleTest()})}})}(APP),function(t){t.views.Login=t.views.View.extend({type:"app.views.Login",init:function(){this._super()},render:function(e,n){e.html('<div class="jumbotron vertical-center login">   <div class="container">       <div class="text-center">           <form class="form-inline" role="form">               <div class="form-group">                   <label for="username"><h4>Логин:</h4></label>                   <input type="text" class="form-control" id="username">               </div>               <button id="login" class="btn btn-large btn-primary" type="button">                   Войти               </button>           </form>       </div>   </div></div>'),$("#login").on("click",function(){var e=$("#username").val();t.obj("Controller").onLogin(e)})}})}(APP),function(t){t.views.MyPage=t.views.View.extend({type:"app.views.MyPage",init:function(){this._super()},render:function(e,n){var s=this,i=n.level,o=n.nextChapter,r="";$.each(n.finishedChapters,function(t,e){r+=e+(t!==n.finishedChapters.length-1?"\n":"")}),e.html('<div class="container-fluid bg-info quiz">   <div class="modal-dialog">       <div class="modal-content">           <div class="modal-header">               <button id="rules" class="btn btn-large btn-primary" type="button"  data-toggle="modal" data-target="#modalWindow">                   Правила обучения               </button>               <button id="logout" class="btn btn-large btn-primary" type="button">                   Выйти               </button>               <div class="modal-body">                   <form class="form-horizontal">                       <div class="form-group">                           <label for="level" class="col-sm-2 control-label">Ваш уровень</label>                           <div class="col-sm-10">                               <div class="form-control" id="level">'+i+'</div>                           </div>                       </div>                       <div class="form-group">                           <label for="nextChapter" class="col-sm-2 control-label">Следующая глава:</label>                           <div class="col-sm-10">                               <textarea disabled class="form-control disabled" rows="5" id="nextChapter">'+o+"</textarea>                           </div>                       </div>"+s.createFinishedChapters(r)+'                   </form>               </div>               <div class="modal-footer">                   <button id="startChapter" class="btn btn-large btn-primary" type="button">                       Начать главу                   </button>               </div>           </div>       </div>'+s.createRules()+"   </div></div>"),$("#logout").on("click",function(){t.obj("Controller").onLogout()}),$("#startChapter").on("click",function(){t.obj("Controller").onStartReadDoc()})},createFinishedChapters:function(t){return 0===t.length?"":'<div class="form-group">       <label for="nextChapter" class="col-sm-2 control-label">Оконченные главы:</label>       <div class="col-sm-10">           <textarea disabled class="form-control disabled" rows="5" id="level">'+t+"</textarea>       </div>   </div>"},createRules:function(){return'<div class="modal fade" id="modalWindow" tabindex="-1" role="dialog" aria-labelledby="modalLabel">   <div class="modal-dialog" role="document">       <div class="modal-content">           <div class="modal-header">               <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>               <h4 class="modal-title" id="modalLabel">Правила игры</h4>           </div>           <div class="modal-body">Перед Вами система, позволяющая обучить пользователей Правилам Дорожного Движения Республики Беларусь.<br>На главной странице Вы можете увидеть Ваш уровень (простое число) и Вашу следующую главу (название главы, которой Вас обучают в данный момент). Также, после успешного прохождения глав Вы увидите список пройденных Вами глав. С самого начала Ваш уровень - 1-ый.<br>Запомните Ваш логин, т.к. благодаря ему происходит привязка к Вашему аккаунту, т.е. к Вашему уровню и пройденным тестам.<br>Порядок глав подобран согласно официальной документации Правил Дорожного Движения Республики Беларусь. По прохождению всех глав Вы получаете наивысший уровень и можете начать обучение заново.<br>Прохождение главы заключается в следующем: Вы нажимаете на кнопку "Начать главу". После нажатия кнопки Вы увидите материал документации Вашей главы, т.е. главы, обозначенной в поле "Следующая глава" Вашей главной страницы. После внимательного изучения материала Вам необходимо пройти 2 теста. 1-й тест - случайным образом подобранные вопросы по данной главе. 2-й тест - выбранные статистическими методами вопросы, среди которых вопросы, на которых пользователи чаще всего ошибаются, и вопросы, в котором Вы совершили ощибку (если такие есть). При неправильных 2 ответах Вам покажет сообщение о том, что тест не пройден и Вам нужно будет проходит всю главу заново, повторно прочитав материала. Если 2 теста пройдены успешно, Ваш уровень повысится и Вам будет предложено перейти на Главную Страницу, где Вы можете продолжить обучение со следующей главы.<br>Пройти 2 главу можно только после завершения 1-ой!<br><h3>Удачного пути!</h3></div>           <div class="modal-footer">               <button type="button" class="btn btn-default" data-dismiss="modal">Закрыть</button>           </div>       </div>   </div></div>'}})}(APP),function(t){t.views.TestPage=t.views.View.extend({type:"app.views.TestPage",init:function(){this._super()},questionId:0,render:function(e,n){var s=this,i=n.index,o=n.title,r=n.variants,a=n.answers;s.questionId=n.index,e.html('<div class="container-fluid bg-info quiz">   <div class="modal-dialog">       <div class="modal-content">           <div class="modal-header question">'+s.createQuestion(i,o)+'           </div>           <div class="modal-body">               <div class="variants" data-toggle="buttons">'+s.createVariants(r)+'               </div>           </div>       </div>       <div class="modal-footer">           <div class="answers btn-group">'+s.createAnswers(i,a)+"           </div>       </div>   </div></div>");for(var l=0;l<r.length;++l)!function(){$("#variant"+l).on("click",function(){var e=$(this).find("input:hidden").val();t.obj("Controller").onSelectVariant(s.questionId,e)})}()},createQuestion:function(t,e){return'<h4><span class="label label-warning" id="questionId">'+(t+1)+"</span> "+e+"</h4>"},createVariants:function(t){var e="";return $.each(t,function(t,n){e+='<label class="btn btn-primary btn-block element-animation" id="variant'+t+'">   <span class="btn-label"><i class="glyphicon glyphicon-chevron-right"></i></span>   <input type="hidden" name="answer" value="'+t+'">'+n+"</label>"}),e},createAnswers:function(t,e){var n=this,s="";for(var i in e){var o=e[i],i=parseInt(i),r=n.getAnswerButtonClass(i,o,t);s+='<label class="btn-sm '+r+'">'+(i+1)+"</label>"}return s},getAnswerButtonClass:function(t,e,n){return t===n?"btn-warning":0===e?"btn-danger":1===e?"btn-success":"btn-default"}})}(APP),function(t){t.views.SimpleTestCompleted=t.views.View.extend({type:"app.views.SimpleTestCompleted",init:function(){this._super()},render:function(e,n){var s=this,i=n.answers;e.html(s.createCenteredInfoPanel(s.createCongratulations("Поздравляем!","Вы прошли первый этап теста!")+s.createAnswers(-1,i)+"<br/><div><h3> Теперь Вам нужно пройти тест с наиболее часто встречающимися ошибками. </h3></div><br/>"+s.createButton("startSpecTest","Начать специальный тест"))),$("#startSpecTest").on("click",function(){t.obj("Controller").onStartSpecialTest()})},createCongratulations:function(t,e){return'<span class="congratulations"><h2>'+t+"<br/>"+e+"</h2></span>"},createButton:function(t,e){return'<button id="'+t+'" class="btn btn-large btn-primary" type="button">'+e+"</button>"},createAnswers:function(e,n){return'<br/>Ваши ответы:<br/><div class="answers btn-group">'+t.obj("TestPage").createAnswers(e,n)+"</div><br/>"},createCenteredInfoPanel:function(t){return'<div class="jumbotron vertical-center"><div class="container"><div class="text-center">'+t+"</div></div></div>"}})}(APP),function(t){t.views.TestFailed=t.views.SimpleTestCompleted.extend({type:"app.views.TestFailed",init:function(){this._super()},render:function(e,n){var s=this,i=n.answers;e.html(s.createCenteredInfoPanel(s.createCongratulations("Жаль!","Вы не прошли тест!")+s.createAnswers(-1,i)+"<br/><div><h3> Попробуйте снова! </h3></div><br/>"+s.createButton("toStartPage","На главную страницу"))),$("#toStartPage").on("click",function(){t.obj("Controller").showStartPage()})}})}(APP),function(t){t.views.SpecificTestCompleted=t.views.View.extend({type:"app.views.SpecificTestCompleted",init:function(){this._super()},render:function(e,n){var s=this,i=n.answers,o=n.level;e.html(s.createCenteredInfoPanel(s.createCongratulations("Поздравляем!","Вы прошли тест!")+s.createAnswers(-1,i)+"<br/><div><h3> Ваш уровень поднялся до <i>"+o+"</i></h3></div><br/>"+s.createButton("toStartPage","На главную"))),$("#toStartPage").on("click",function(){t.obj("Controller").showStartPage()})},createCongratulations:function(t,e){return'<span class="congratulations"><h2>'+t+"<br/>"+e+"</h2></span>"},createButton:function(t,e){return'<button id="'+t+'" class="btn btn-large btn-primary" type="button">'+e+"</button>"},createAnswers:function(e,n){return'<br/>Ваши ответы:<br/><div class="answers btn-group">'+t.obj("TestPage").createAnswers(e,n)+"</div><br/>"},createCenteredInfoPanel:function(t){return'<div class="jumbotron vertical-center"><div class="container"><div class="text-center">'+t+"</div></div></div>"}})}(APP),function(t){t.controllers.Controller=Class.extend({type:"app.controllers.Controller",init:function(){var t=this;t.clearWindow(),t.showLoginPage()},clearWindow:function(){$(document.body).html("")},showLoginPage:function(){t.obj("Login").render($(document.body))},onLogin:function(e){if(!e||!/^[А-Яа-яA-Za-z0-9_]{1,20}$/.test(e))return void alert("Плохой логин :-)");$(".login").fadeOut(500);var n=this,s=t.obj("Users"),i=s.findById(e);i||(i=s.create({username:e,level:1,finishedChapters:[],nextChapter:1,wrongAnswers:[]})),t.user=i,n.showStartPage(),1===t.user.get("level")&&$("#rules").click()},showStartPage:function(){t.obj("MyPage").render($(document.body),{level:t.user.get("level"),nextChapter:t.obj("Chapters").getTitle(t.user.get("nextChapter")),finishedChapters:t.obj("Chapters").getTitles(t.user.get("finishedChapters"))})},onLogout:function(){var e=this;t.user=null,e.clearWindow(),e.showLoginPage()},onStartReadDoc:function(){var t=this;t.clearWindow(),t.showDocs()},showDocs:function(){var e=t.obj("Chapters").findById(t.user.get("nextChapter"));t.obj("Docs").render($(document.body),{title:e.get("title"),text:e.get("text")})},onStartSimpleTest:function(){var e=this,n=t.user.get("nextChapter");t.test=t.obj("Questions").getRandomTest(n,10),e.showTestPage()},showTestPage:function(){var e=t.test.getCurrentQuestion();t.obj("TestPage").render($(document.body),{index:t.test.get("questionId"),title:e.get("name"),variants:e.get("variants"),answers:t.test.get("answers")})},onSelectVariant:function(e,n){var s=this,i=t.test.getCurrentQuestion(),o=parseInt(n)===i.get("correct");s.updateAnswers(e,o),o||(t.obj("WrongAnswers").addRecord(i),t.user.get("wrongAnswers").push(i)),s.containsTwoFails(t.test.get("answers"))?s.onFailedTest():t.test.isLast(e)?(t.test.set("questionId",e+1),s.onFinishTest()):(t.test.set("questionId",e+1),s.onNextQuestion())},updateAnswers:function(e,n){var s=t.test.get("answers");s[e]=n?1:0,t.test.set("answers",s)},containsTwoFails:function(t){var e,n=0;for(e in t)if(0===t[e]&&++n,2===n)return!0;return!1},onNextQuestion:function(){this.showTestPage()},onFailedTest:function(){t.obj("TestFailed").render($(document.body),{answers:t.test.get("answers")})},onFinishTest:function(){var e=this;t.test.get("specific")?e.onFinishSpecificTest():e.onFinishSimpleTest()},onStartSpecialTest:function(){var e,n=this,s=t.user.get("nextChapter"),i=1,o=5,r=10,a=[],l=t.user.get("wrongAnswers").filter(function(t){return t.get("chapterId")===s});e=t.obj("Questions").getRandomQuestionsFrom(l,s,i,a),e=e.concat(t.obj("WrongAnswers").getRandomQuestions(s,o,a)),e=e.concat(t.obj("Questions").getRandomQuestions(s,r-e.length,a)),t.test=new t.models.Test({questionId:0,questions:e,answers:t.obj("Questions").getDefaultAnswers(r),specific:!0}),n.showTestPage()},onFinishSimpleTest:function(){t.obj("SimpleTestCompleted").render($(document.body),{answers:t.test.get("answers")})},onFinishSpecificTest:function(){this.upgradeUser(),t.obj("SpecificTestCompleted").render($(document.body),{answers:t.test.get("answers"),level:t.user.get("level")})},upgradeUser:function(){var e,n=t.user,s=n.get("nextChapter");n.set("level",n.get("level")+1),e=n.get("finishedChapters"),e.push(s),n.set("finishedChapters",e),++s,t.obj("Chapters").count()<s&&(s=1),n.set("nextChapter",s)}})}(APP),$(function(){APP.init()});